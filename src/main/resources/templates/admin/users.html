<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Users - Admin Dashboard - Jobify</title>
    <link th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/webjars/font-awesome/css/all.min.css}" rel="stylesheet">
    <link th:href="@{/css/admin-styles.css}" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
</head>

<body th:classappend="${session.theme == 'light' ? 'light-theme' : ''}">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar" th:replace="~{admin/fragments/sidebar :: sidebar(activeLink='users')}">
        <!-- Content replaced by fragment -->
    </aside>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Top Bar -->
        <div class="top-bar">
            <button class="btn btn-primary d-lg-none me-3" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="page-title">
                <div class="title-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <h1 class="h3 fw-bold mb-1">All Users</h1>
                    <p class="text-muted mb-0">Manage and monitor all platform users</p>
                </div>
            </div>

            <div class="user-menu">
                <!-- Theme Toggle Removed -->
                <a href="/logout" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>

        <!-- Users Container -->
        <div class="card border-0 shadow-sm" style="background: var(--bg-card); border-radius: var(--radius);">
            <div class="table-responsive">
                <table class="table admin-table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">User</th>
                            <th>Type</th>
                            <th>Email</th>
                            <th>Registration</th>
                            <th>Status</th>
                            <th>Verification</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${users.isEmpty()}">
                            <td colspan="7" class="text-center py-5 text-muted">
                                <i class="fas fa-users-slash fa-3x mb-3 opacity-25"></i>
                                <p class="mb-0">No users found.</p>
                            </td>
                        </tr>
                        <tr th:each="user : ${users}">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-initial me-3"
                                        th:if="${user.userTypeId?.userTypeId == 1 and recruiterProfiles[user.userId] != null}"
                                        style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;"
                                        th:text="${!#strings.isEmpty(recruiterProfiles[user.userId].firstName) ? #strings.substring(recruiterProfiles[user.userId].firstName, 0, 1) : 'C'}">
                                        C
                                    </div>
                                    <div class="avatar-initial me-3"
                                        th:if="${user.userTypeId?.userTypeId == 2 and jobSeekerProfiles[user.userId] != null}"
                                        style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--success) 0%, #047a4e 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;"
                                        th:text="${!#strings.isEmpty(jobSeekerProfiles[user.userId].firstName) ? #strings.substring(jobSeekerProfiles[user.userId].firstName, 0, 1) : 'F'}">
                                        F
                                    </div>
                                    <div class="avatar-initial me-3"
                                        th:if="${(user.userTypeId?.userTypeId == 1 and recruiterProfiles[user.userId] == null) or (user.userTypeId?.userTypeId == 2 and jobSeekerProfiles[user.userId] == null) or user.userTypeId == null}"
                                        style="width: 40px; height: 40px; background: var(--bg-light); color: var(--text-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                        ?
                                    </div>

                                    <div>
                                        <h6 class="mb-0 fw-bold text-dark"
                                            th:if="${user.userTypeId?.userTypeId == 1 and recruiterProfiles[user.userId] != null}">
                                            <span th:text="${recruiterProfiles[user.userId].firstName}">First</span>
                                            <span th:text="${recruiterProfiles[user.userId].lastName}">Last</span>
                                        </h6>
                                        <h6 class="mb-0 fw-bold text-dark"
                                            th:if="${user.userTypeId?.userTypeId == 2 and jobSeekerProfiles[user.userId] != null}">
                                            <span th:text="${jobSeekerProfiles[user.userId].firstName}">First</span>
                                            <span th:text="${jobSeekerProfiles[user.userId].lastName}">Last</span>
                                        </h6>
                                        <h6 class="mb-0 fw-bold text-muted"
                                            th:if="${(user.userTypeId?.userTypeId == 1 and recruiterProfiles[user.userId] == null) or (user.userTypeId?.userTypeId == 2 and jobSeekerProfiles[user.userId] == null) or user.userTypeId == null}">
                                            No Profile
                                        </h6>
                                        <small class="text-muted" th:text="${user.email}">Email</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-soft-info text-info rounded-pill px-3"
                                    th:if="${user.userTypeId != null and user.userTypeId.userTypeId == 1}"
                                    style="background: rgba(var(--info-rgb), 0.1); color: var(--info) !important;">Client</span>
                                <span class="badge bg-soft-success text-success rounded-pill px-3"
                                    th:if="${user.userTypeId != null and user.userTypeId.userTypeId == 2}"
                                    style="background: rgba(var(--success-rgb), 0.1); color: var(--success) !important;">Freelancer</span>
                                <span class="badge bg-soft-secondary text-secondary rounded-pill px-3"
                                    th:if="${user.userTypeId == null}">Unknown</span>
                            </td>
                            <td class="text-muted" th:text="${user.email}">email@example.com</td>
                            <td class="text-muted">
                                <span th:if="${user.registrationDate != null}"
                                    th:text="${#dates.format(user.registrationDate, 'MMM dd, yyyy')}">Jan 01,
                                    2024</span>
                                <span th:unless="${user.registrationDate != null}">-</span>
                            </td>
                            <td>
                                <span class="badge rounded-pill"
                                    th:classappend="${user.approved ? 'bg-success' : 'bg-warning'}"
                                    th:text="${user.approved ? 'Active' : 'Pending'}">Status</span>
                            </td>
                            <td>
                                <!-- Verification Badge Logic -->
                                <span class="badge rounded-pill bg-success"
                                    th:if="${(user.userTypeId?.userTypeId == 1 and recruiterProfiles[user.userId]?.isVerified == true) or (user.userTypeId?.userTypeId == 2 and jobSeekerProfiles[user.userId]?.isVerified == true)}">
                                    <i class="fas fa-check-circle me-1"></i> Verified
                                </span>
                                <span class="badge rounded-pill bg-light text-dark border"
                                    th:if="${(user.userTypeId?.userTypeId == 1 and recruiterProfiles[user.userId]?.isVerified != true) or (user.userTypeId?.userTypeId == 2 and jobSeekerProfiles[user.userId]?.isVerified != true)}">
                                    Unverified
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <div class="d-flex justify-content-end gap-2">
                                    <form th:action="@{/admin/users/delete}" method="post"
                                        onsubmit="return confirm('Are you sure you want to delete this user?');"
                                        style="display: inline;">
                                        <input type="hidden" name="userId" th:value="${user.userId}" />
                                        <button type="submit" class="btn btn-sm btn-icon btn-outline-danger"
                                            title="Delete User">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>

                                    <form th:if="${!user.approved}" th:action="@{/admin/users/approve}" method="post"
                                        style="display: inline;">
                                        <input type="hidden" name="userId" th:value="${user.userId}" />
                                        <button type="submit" class="btn btn-sm btn-icon btn-outline-success"
                                            title="Approve User">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>

                                    <!-- Verification Button -->
                                    <form
                                        th:if="${user.userTypeId?.userTypeId == 1 and recruiterProfiles[user.userId] != null and recruiterProfiles[user.userId].isVerified != true}"
                                        th:action="@{/admin/users/verify}" method="post" style="display: inline;">
                                        <input type="hidden" name="userId" th:value="${user.userId}" />
                                        <button type="submit" class="btn btn-sm btn-icon btn-outline-primary"
                                            title="Verify User">
                                            <i class="fas fa-shield-alt"></i>
                                        </button>
                                    </form>

                                    <form th:if="${user.active == true and user.userTypeId?.userTypeId != 3}"
                                        th:action="@{/admin/users/ban}" method="post" style="display: inline;"
                                        onsubmit="return confirmBan(this);">
                                        <input type="hidden" name="userId" th:value="${user.userId}" />
                                        <button type="submit" class="btn btn-sm btn-icon btn-outline-danger"
                                            title="Ban User">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    </form>

                                    <!-- Unban User -->
                                    <form th:if="${user.active == false}" th:action="@{/admin/users/unban}"
                                        method="post" style="display: inline;"
                                        onsubmit="return confirm('Are you sure you want to unban this user?');">
                                        <input type="hidden" name="userId" th:value="${user.userId}" />
                                        <button type="submit" class="btn btn-sm btn-icon btn-outline-success"
                                            title="Unban User">
                                            <i class="fas fa-unlock"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="card-footer bg-transparent border-top border-light py-3" th:if="${totalPages > 1}">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        Showing <span th:text="${currentPage * pageSize + 1}">1</span> to
                        <span
                            th:text="${(currentPage + 1) * pageSize < totalUsers ? (currentPage + 1) * pageSize : totalUsers}">10</span>
                        of <span th:text="${totalUsers}">0</span> users
                    </div>
                    <nav aria-label="Users pagination">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                <a class="page-link rounded-start-pill border-0 shadow-sm"
                                    th:href="@{/admin/users(page=${currentPage - 1}, size=${pageSize})}">
                                    <i class="fas fa-chevron-left me-1"></i> Previous
                                </a>
                            </li>
                            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                th:classappend="${i == currentPage} ? 'active'">
                                <a class="page-link border-0 shadow-sm mx-1 rounded-circle"
                                    style="width: 30px; height: 30px; text-align: center; line-height: 18px;"
                                    th:href="@{/admin/users(page=${i}, size=${pageSize})}" th:text="${i + 1}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                <a class="page-link rounded-end-pill border-0 shadow-sm"
                                    th:href="@{/admin/users(page=${currentPage + 1}, size=${pageSize})}">
                                    Next <i class="fas fa-chevron-right ms-1"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </main>

    <!-- Short Admin Footer -->
    <div th:replace="~{admin/fragments/footer :: adminFooter}"></div>

    <script th:src="@{/webjars/jquery/jquery.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:src="@{/js/admin-scripts.js}"></script>
</body>

</html>