<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8" />
    <title>Payments - Jobify</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/webjars/font-awesome/css/all.min.css}" />
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <!-- Add jQuery for notifications.js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root {
            --primary: #4B6CB7;
            --primary-light: #182848;
            --accent: #00b4d8;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            /* Modern palette */
            --bg-body: #f5f7fa;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.4);
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --radius-xl: 20px;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #2D3436;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 20px;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            position: relative;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 4px;
            transition: width 0.4s ease;
        }

        .stat-card:hover::after {
            width: 100%;
        }

        .stat-value {
            font-size: 38px;
            font-weight: 800;
            margin-bottom: 2px;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 13px;
            font-weight: 700;
            color: #636E72;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 32px;
            opacity: 0.15;
            transition: all 0.4s ease;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.2) rotate(-10deg);
            opacity: 0.3;
        }

        .stat-card.blue::after {
            background: #4B6CB7;
        }

        .stat-card.green::after {
            background: #2ecc71;
        }

        .stat-card.purple::after {
            background: #9b59b6;
        }

        .stat-card.orange::after {
            background: #e67e22;
        }

        /* Content Card */
        .content-card {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.6), var(--card-shadow);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header-premium {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.4);
        }

        .card-title {
            font-size: 18px;
            font-weight: 800;
            margin: 0;
            color: var(--primary-light);
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }

        /* Modern Table */
        .table-premium {
            width: 100%;
            margin-bottom: 0;
            border-color: rgba(0, 0, 0, 0.05);
        }

        .table-premium th {
            padding: 16px 24px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #636E72;
            background: rgba(255, 255, 255, 0.5);
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            border-top: none;
        }

        .table-premium td {
            padding: 16px 24px;
            vertical-align: middle;
            font-size: 14px;
            color: var(--primary-light);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 500;
        }

        .table-premium tr:last-child td {
            border-bottom: none;
        }

        .table-premium tr:hover td {
            background: rgba(75, 108, 183, 0.04);
        }

        /* Status Badges */
        .badge-soft {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-soft.success {
            background: rgba(46, 204, 113, 0.15);
            color: #27ae60;
        }

        .badge-soft.warning {
            background: rgba(241, 196, 15, 0.15);
            color: #d35400;
        }

        /* Animations */
        .animate-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .counter {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>

<body>

    <!-- Unified Header -->
    <th:block th:replace="fragments/client-header :: clientHeader('payments')"></th:block>

    <div class="container-fluid py-3" style="max-width: 1400px;">

        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4 animate-up">
            <div>
                <h2 class="fw-bold mb-1" style="color: var(--primary-light);">Financial Overview</h2>
                <p class="text-muted mb-0">Track your project expenses and payment history.</p>
            </div>
            <a th:href="@{/client-dashboard/}" class="btn btn-outline-primary rounded-pill px-4">
                <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
            </a>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid animate-up" style="animation-delay: 0.1s;">
            <!-- Total Paid Stat -->
            <div class="stat-card blue">
                <div class="stat-value counter" th:data-target="${totalPaid != null ? totalPaid : 0}">0</div>
                <div class="stat-label">Total Paid</div>
                <i class="fas fa-wallet stat-icon"></i>
            </div>

            <!-- Avg Project Value (Derived) -->
            <div class="stat-card green">
                <div class="d-flex align-items-baseline">
                    <span class="stat-value text-success">$</span>
                    <div class="stat-value counter"
                        th:data-target="${totalProjectValue != null ? totalProjectValue : 0}">0</div>
                </div>
                <div class="stat-label">Total Project Value</div>
                <i class="fas fa-chart-pie stat-icon"></i>
            </div>

            <!-- Pending Projects -->
            <div class="stat-card purple">
                <div class="stat-value counter"
                    th:data-target="${ongoingProjects != null ? ongoingProjects.size() : 0}">0</div>
                <div class="stat-label">Active Projects</div>
                <i class="fas fa-hourglass-half stat-icon"></i>
            </div>
        </div>

        <!-- Alert Messages -->
        <div th:if="${error}" class="alert alert-danger shadow-sm rounded-4 animate-up" role="alert"
            style="animation-delay: 0.2s;">
            <i class="fas fa-exclamation-circle me-2"></i> <span th:text="${error}"></span>
        </div>
        <div th:if="${success}" class="alert alert-success shadow-sm rounded-4 animate-up" role="alert"
            style="animation-delay: 0.2s;">
            <i class="fas fa-check-circle me-2"></i> <span th:text="${success}"></span>
        </div>

        <!-- Payments Table Card -->
        <div class="content-card animate-up" style="animation-delay: 0.3s;">
            <div class="card-header-premium">
                <h5 class="card-title"><i class="fas fa-history me-2"></i> Active Projects & Payments</h5>
            </div>

            <div class="table-responsive">
                <table class="table table-premium table-hover">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Freelancer</th>
                            <th>Agreed Rate</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="project : ${ongoingProjects}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="rounded-3 bg-light p-2 me-3 text-primary">
                                        <i class="fas fa-rocket"></i>
                                    </div>
                                    <span class="fw-bold"
                                        th:text="${project.job?.jobTitle ?: 'Unknown Project'}">Project Title</span>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <!-- Use project.userId which IS the JobSeekerProfile -->
                                    <div th:if="${project.userId != null}">
                                        <!-- Corrected Image Path using helper -->
                                        <img th:if="${project.userId.photosImagePath != null}"
                                            th:src="@{${project.userId.photosImagePath}}"
                                            class="rounded-circle border border-2 border-white shadow-sm me-2"
                                            width="32" height="32"
                                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />

                                        <div th:unless="${project.userId.photosImagePath != null}"
                                            class="rounded-circle bg-light d-flex align-items-center justify-content-center border border-2 border-white shadow-sm me-2 text-muted"
                                            style="width: 32px; height: 32px; font-size: 12px;">
                                            <span
                                                th:text="${project.userId.firstName != null ? #strings.substring(project.userId.firstName, 0, 1) : 'U'}">U</span>
                                        </div>
                                        <span
                                            th:text="${(project.userId.firstName ?: '') + ' ' + (project.userId.lastName ?: '')}">Freelancer
                                            Name</span>
                                    </div>
                                    <div th:unless="${project.userId != null}">
                                        <span class="text-muted">Unknown Freelancer</span>
                                    </div>
                                </div>
                            </td>
                            <td class="fw-bold text-dark" th:text="${'$' + (project.proposedRate ?: '0.00')}">$0.00</td>
                            <td>
                                <span class="badge-soft warning">Pending Payment</span>
                            </td>
                            <td>
                                <form th:if="${project.job != null}" th:action="@{/client-dashboard/process-payment}"
                                    method="post" class="d-inline">
                                    <input type="hidden" name="projectId" th:value="${project.job.jobPostId}" />
                                    <input type="hidden" name="paymentMethod" value="Direct Transfer" />
                                    <!-- Pay Now Button -->
                                    <button type="submit"
                                        class="btn btn-success btn-sm rounded-pill px-4 fw-bold shadow-sm"
                                        style="min-width: 100px; height: 32px; font-size: 13px; transition: all 0.3s ease;"
                                        onclick="return confirm('Process payment for this project?')">
                                        <i class="fas fa-credit-card me-2"></i>Pay Now
                                    </button>
                                </form>
                            </td>
                        </tr>
                        <!-- Empty State -->
                        <tr th:if="${ongoingProjects == null or ongoingProjects.isEmpty()}">
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="fas fa-folder-open fa-2x mb-3 opacity-50"></i>
                                <p class="mb-0">No active projects requiring payment.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Scripts -->

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Check visibility of elements first
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.animate-up').forEach(el => observer.observe(el));


            // Dynamic Counter Animation
            const counters = document.querySelectorAll('.counter');
            counters.forEach(counter => {
                const targetText = counter.getAttribute('data-target');
                const target = targetText ? +targetText : 0;

                const duration = 1500; // 1.5s animation
                const increment = target > 0 ? target / (duration / 16) : 0;

                if (target === 0) {
                    counter.innerText = "0";
                    return;
                }

                let current = 0;
                const updateCounter = () => {
                    current += increment;
                    if (current < target) {
                        counter.innerText = Math.ceil(current);
                        requestAnimationFrame(updateCounter);
                    } else {
                        counter.innerText = target;
                    }
                };
                // Small delay to start animation after page load
                setTimeout(updateCounter, 300);
            });
        });
    </script>

</body>

</html>