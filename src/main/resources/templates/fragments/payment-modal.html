<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
    <div th:fragment="paymentModal">
        <!-- Stripe JS -->
        <script src="https://js.stripe.com/v3/"></script>

        <!-- Payment Modal -->
        <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="paymentModalLabel">Secure Payment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-lock me-2"></i>
                            <strong>Secure Payment:</strong> Enter your details below.
                        </div>

                        <!-- Project Details Display -->
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Project</small>
                                    <div class="fw-bold" id="modalProjectName"></div>
                                </div>
                                <div class="col-6 text-end">
                                    <small class="text-muted">Amount</small>
                                    <div class="fw-bold text-success" id="modalTotal"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Stripe Payment Element Container -->
                        <form id="payment-form">
                            <div id="payment-element">
                                <!-- Stripe.js will mount the elements here -->
                            </div>

                            <div id="error-message" class="text-danger mt-2 small"></div>

                            <div class="d-grid gap-2 mt-4">
                                <button id="submit" class="btn btn-primary">
                                    <div class="spinner-border spinner-border-sm me-2 d-none" id="spinner"
                                        role="status"></div>
                                    <span id="button-text">Pay Now</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logic -->
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function () {
                const stripePublicKey = /*[[${@environment.getProperty('stripe.public.key')}]]*/ '';
                const stripe = Stripe(stripePublicKey);
                let elements;
                let currentJobId;
                let currentAmount;

                const paymentModal = document.getElementById('paymentModal');
                if (paymentModal) {
                    paymentModal.addEventListener('show.bs.modal', function (event) {
                        const button = event.relatedTarget;
                        const projectId = button.getAttribute('data-project-id');
                        const projectTitle = button.getAttribute('data-project-title');
                        const rate = button.getAttribute('data-rate'); // Assuming rate is effectively total for now or calculation is done before

                        // Update UI
                        document.getElementById('modalProjectName').textContent = projectTitle;

                        let amount = 0;
                        if (rate) {
                            amount = parseFloat(rate);
                            // If logic requires adding 10% fee again, handle it here. 
                            // Based on client-payments.html value logic: Total = Rate + (Rate * 0.10)
                            // Ideally pass the TOTAL from the button if possible.
                            // Let's assume the button passes the base Rate, and we calculate Total.
                            const total = amount + (amount * 0.10);
                            currentAmount = total.toFixed(2);
                            document.getElementById('modalTotal').textContent = '$' + currentAmount;
                        }

                        currentJobId = projectId;

                        initializePayment();
                    });
                }

                async function initializePayment() {
                    if (!currentJobId || !currentAmount) return;

                    const response = await fetch("/payment/create-payment-intent", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams({ jobId: currentJobId, amount: currentAmount })
                    });

                    const { clientSecret, error } = await response.json();

                    if (error) {
                        document.getElementById('error-message').textContent = error;
                        return;
                    }

                    const appearance = { theme: 'stripe' };
                    elements = stripe.elements({ appearance, clientSecret });

                    const paymentElement = elements.create("payment");
                    paymentElement.mount("#payment-element");
                }

                const form = document.getElementById("payment-form");
                form.addEventListener("submit", handleSubmit);

                async function handleSubmit(e) {
                    e.preventDefault();
                    setLoading(true);

                    const { error } = await stripe.confirmPayment({
                        elements,
                        confirmParams: {
                            // Make sure to change this to your payment completion page
                            return_url: window.location.origin + "/payment/success",
                            // Or simpler: just let it default to current page if we want, 
                            // but success page is better for verification. 
                            // We need to handle the success callback which validates the intent status.
                            // The current /payment/success endpoint expects ?session_id=... 
                            // But PaymentIntent redirect will have ?payment_intent=...&payment_intent_client_secret=...
                            // I NEED TO UPDATE PaymentController to handle PaymentIntent redirect too!
                        },
                    });

                    if (error.type === "card_error" || error.type === "validation_error") {
                        showMessage(error.message);
                    } else {
                        showMessage("An unexpected error occurred.");
                    }

                    setLoading(false);
                }

                function showMessage(messageText) {
                    const messageContainer = document.querySelector("#error-message");
                    messageContainer.textContent = messageText;
                }

                function setLoading(isLoading) {
                    if (isLoading) {
                        document.querySelector("#submit").disabled = true;
                        document.querySelector("#spinner").classList.remove("d-none");
                        document.querySelector("#button-text").classList.add("d-none");
                    } else {
                        document.querySelector("#submit").disabled = false;
                        document.querySelector("#spinner").classList.add("d-none");
                        document.querySelector("#button-text").classList.remove("d-none");
                    }
                }
            });
        </script>
    </div>
</body>

</html>